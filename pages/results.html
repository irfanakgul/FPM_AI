<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FPM - Results</title>

<style>
    body { margin:0; font-family:system-ui; background:#f4f6f8; }

    header {
        height:60px; background:#0275d8; color:white;
        display:flex; align-items:center; justify-content:space-between;
        padding:0 20px; position:fixed; top:0; left:0; right:0; z-index:10;
    }

    #headerUserInfo { font-size:14px; opacity:0.9; }

    #sidebar {
        width:200px; background:white; position:fixed;
        top:60px; left:0; bottom:0; border-right:1px solid #ddd;
        padding-top:20px;
    }
    #sidebar a {
        display:block; padding:12px 16px; text-decoration:none; color:#333;
    }
    #sidebar a:hover { background:#e5e5e5; }
    #sidebar .active { background:#0275d8; color:white; }

    #main { margin-left:200px; margin-top:60px; padding:20px; padding-bottom:60px; }

    table { width:100%; border-collapse:collapse; background:white; margin-top:12px; }
    th,td { border:1px solid #ccc; padding:8px; font-size:13px; }
    th { background:#fafafa; }
    .editable { background:#fff7d1; }

    #status { margin-top:10px; font-size:14px; }
    #status.success { color:#0a7a0a; font-weight:bold; }
    #status.error { color:#b30000; font-weight:bold; }

    #noPermissionBox {
        display:none; color:#b30000; background:#ffe5e5;
        border:1px solid #cc0000; padding:12px; font-weight:bold;
        margin-bottom:10px;
    }

    footer {
        position:fixed; bottom:0; left:200px; right:0;
        height:40px; background:#f0f0f0; border-top:1px solid #ddd;
        display:flex; align-items:center; justify-content:center;
        font-size:14px; color:#777;
    }
</style>
</head>

<body>

<header>
    <div style="display:flex;align-items:center;gap:10px;">
        <img src="/docs/fpm_logo.jpg" 
             alt="Logo"
             style="height:34px; width:auto; border-radius:4px;" />

        <strong>FPM AI Model</strong>
    </div>
    <div id="sheetIdLabel"></div>

    <div style="display:flex;align-items:center;gap:20px;">
        <div id="headerUserInfo" style="display:none;"></div>
        <button id="logoutBtn">Logout</button>
    </div>
</header>

<div id="sidebar">
    <a href="/index.html">Home</a>
    <a class="active" href="/pages/results.html">Results</a>
    <a href="/pages/stats.html">Statistics</a>
    <a href="/pages/weekly.html">Weekly Games</a>
    <a href="/pages/about.html">About</a>
</div>

<div id="main">

    <div id="noPermissionBox">You do not have permission to access this page.</div>

    <h2>Results</h2>

    <div id="selectedSheetLabel" style="margin-bottom:10px; font-weight:600;"></div>

    <div>
        <button id="loadSheetsBtn">Load Sheets</button>

        <label>Sheet:
            <select id="sheetSelect"></select>
        </label>

        <button id="updateBtn" style="background:#28a745;color:white;">Update</button>
        <button id="syncStatusBtn" style="background:#6f42c1;color:white; display:none;">
        Sync
        </button>
        <button id="exportExcelBtn" style="background:#1a73e8;color:white;">Export Excel</button>
    </div>

    <div style="margin-top:10px;">
        <label>Match Date:
            <select id="dateSelect" multiple size="6" style="min-width:200px;"></select>
        </label>
        <button id="selectAllBtn">All</button>
    </div>

    <div style="margin-top:8px;">
        <button id="filterBtn">Filter</button>
        <button id="clearBtn">Clear</button>
    </div>

    <div id="status">Ready.</div>

    <div id="tableWrap"></div>

</div>

<footer>© 2025 FPM Web App</footer>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* ============================================================
       SESSION + HEADER SETUP
    ============================================================ */
    const currentUser = JSON.parse(sessionStorage.getItem("currentUser")||"null");
    if (!currentUser) return (window.location.href="/pages/login.html");

    const headerUserInfo = document.getElementById("headerUserInfo");
    headerUserInfo.style.display="block";
    headerUserInfo.innerHTML =
    `User: <strong>${currentUser.username}</strong> 
    (Type: ${currentUser.user_type}) |
    <span id="activeTimer">Active: 0m 0s</span>`;

    document.getElementById("logoutBtn").onclick = () => {
        sessionStorage.clear();
        window.location.href="/index.html";
    };

    // SHOW SYNC BUTTON ONLY FOR ADMIN
    if (currentUser.user_type === "admin") {
        document.getElementById("syncStatusBtn").style.display = "inline-block";
    }

    /* TIMER */
    let s = Number(sessionStorage.getItem("activeSeconds")||0);
    setInterval(()=>{
        s++; sessionStorage.setItem("activeSeconds",s);
        let m=Math.floor(s/60),sec=s%60;
        const t=document.getElementById("activeTimer");
        if(t) t.textContent=`Active: ${m}m ${sec}s`;
    },1000);

    /* ============================================================
       ELEMENTS
    ============================================================ */
    const sheetId = "1c_0Maup2VkR1yg-RjkCbVS1e7d_ng0wgMGY43nFPn3U";

    const loadSheetsBtn = document.getElementById("loadSheetsBtn");
    const sheetSelect = document.getElementById("sheetSelect");
    const dateSelect = document.getElementById("dateSelect");
    const filterBtn = document.getElementById("filterBtn");
    const updateBtn = document.getElementById("updateBtn");
    const exportBtn = document.getElementById("exportExcelBtn");
    const statusDiv = document.getElementById("status");
    const tableWrap = document.getElementById("tableWrap");
    const noPermissionBox = document.getElementById("noPermissionBox");
    const sheetIdLabel = document.getElementById("sheetIdLabel");

    let cachedSheets = {};
    let editedChanges = {};

    /* ============================================================
       PERMISSION LOGIC
    ============================================================ */

    function denies(op) {
        statusDiv.className="error";
        statusDiv.textContent = op+" — You do not have permission.";
        return false;
    }

    const type = currentUser.user_type;

    if (type==="admin") sheetIdLabel.textContent=`Sheet ID: ${sheetId}`;
    else sheetIdLabel.textContent="";

    if (type === "client") {
    // Show only permission warning
    noPermissionBox.style.display = "block";

    // Hide ALL Results UI content
    [
        "selectedSheetLabel",
        "loadSheetsBtn",
        "sheetSelect",
        "dateSelect",
        "selectAllBtn",
        "filterBtn",
        "clearBtn",
        "updateBtn",
        "exportExcelBtn",
        "tableWrap",
        "status"
    ].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
    });

    // Hide text labels and headings
    const hideSelectors = [
        "#main h2",                       // Results title
        "label[for='sheetSelect']",       // Sheet label
        "label[for='dateSelect']",        // Match date label
        "#main label"                     // any other leftover labels inside main
    ];

    hideSelectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(el => {
            el.style.display = "none";
        });
    });
}


    /* ============================================================
       LOAD SHEET LIST
    ============================================================ */
    loadSheetsBtn.onclick = async () => {
        if (type==="client") return denies("Load Sheets");

        statusDiv.textContent="Loading sheet list...";

        const res = await fetch(`/api/sheets?sheetId=${sheetId}`);
        const json = await res.json();

        if (!json.success){ statusDiv.textContent="Error loading sheets."; return; }

        sheetSelect.innerHTML="";
        json.sheets.forEach(s => sheetSelect.innerHTML+=`<option>${s}</option>`);

        loadSheetData(json.sheets[0]);

        statusDiv.className="success";
        statusDiv.textContent="Sheets loaded.";
    };

    /* ============================================================
       LOAD SELECTED SHEET
    ============================================================ */
    sheetSelect.onchange = () => {
        if (type==="client") return denies("Select Sheet");
        loadSheetData(sheetSelect.value);
    };

    async function loadSheetData(sheetName){
        statusDiv.textContent = "Loading sheet: "+sheetName;
        document.getElementById("selectedSheetLabel").textContent =
            "Selected sheet: "+sheetName;

        const res = await fetch("/api/load-sheet", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({sheetId, sheetName})
        });

        const json = await res.json();
        if (!json.success){ statusDiv.textContent="Error loading sheet."; return; }

        cachedSheets[sheetName] = json.data;
        loadDates(sheetName);

        statusDiv.className="success";
        statusDiv.textContent=json.data.length+" rows loaded.";
    }

    /* ============================================================
       DATE LOADING
    ============================================================ */
    function loadDates(sheetName){
        const rows = cachedSheets[sheetName]||[];
        dateSelect.innerHTML="";
        [...new Set(rows.map(r=>r["MacTarihi"]))].forEach(d=>{
            if(d) dateSelect.innerHTML+=`<option>${d}</option>`;
        });
    }

    document.getElementById("selectAllBtn").onclick=()=>{
        [...dateSelect.options].forEach(o=>o.selected=true);
    };

    /* ============================================================
       FILTER
    ============================================================ */
    filterBtn.onclick = ()=>{
        if (type==="client") return denies("Filter");

        const dates = [...dateSelect.selectedOptions].map(o=>o.value);
        const sheetName = sheetSelect.value;

        if(!sheetName||dates.length===0){
            statusDiv.textContent="Select sheet + date(s)";
            return;
        }

        const rows = cachedSheets[sheetName].filter(
            r => dates.includes(r["MacTarihi"])
        );

        renderTable(Object.keys(rows[0]||{}), rows);

        statusDiv.className="success";
        statusDiv.textContent=rows.length+" rows found.";
    };

    /* ============================================================
       CLEAR
    ============================================================ */
    document.getElementById("clearBtn").onclick=()=>{
        tableWrap.innerHTML="";
        statusDiv.textContent="Cleared.";
    };

    /* ============================================================
       RENDER TABLE
    ============================================================ */
    function renderTable(headers, rows){
        editedChanges={};

        let html=`<table><thead><tr>`;
        headers.forEach(h=>html+=`<th>${h}</th>`);
        html+=`</tr></thead><tbody>`;

        rows.forEach((r,i)=>{
            html+="<tr>";
            headers.forEach(h=>{

                let editable=false;
                if(type==="admin") editable=true;
                if(type==="co-admin" && h==="STATUS") editable=true;

                html+=`
                <td data-row="${i}" data-col="${h}"
                    ${editable?'contenteditable="true" class="editable"':''}>
                    ${r[h]||""}
                </td>`;
            });
            html+="</tr>";
        });

        html+="</tbody></table>";
        tableWrap.innerHTML=html;

        document.querySelectorAll("td[contenteditable]").forEach(td=>{
            td.oninput=()=>{
                const sheet=sheetSelect.value;
                const row=td.dataset.row;
                const col=td.dataset.col;

                if(!editedChanges[sheet]) editedChanges[sheet]={};
                if(!editedChanges[sheet][row]) editedChanges[sheet][row]={};

                editedChanges[sheet][row][col]=td.textContent.trim();
            };
        });
    }

    /* ============================================================
       UPDATE
    ============================================================ */
    updateBtn.onclick = async ()=>{
        if(type==="read" || type==="client") return denies("Update");

        const sheetName=sheetSelect.value;
        const changes=editedChanges[sheetName]||{};

        if(Object.keys(changes).length===0){
            statusDiv.textContent="No changes.";
            return;
        }

        statusDiv.textContent="Updating...";

        const res=await fetch("/api/update-cells",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({sheetId, sheetName, userType:type, changes})
        });

        const json=await res.json();

        if(json.success){
            statusDiv.className="success";
            statusDiv.textContent="Updated!";
        } else {
            statusDiv.className="error";
            statusDiv.textContent=json.error;
        }
    };

    /* ============================================================
       EXPORT EXCEL
    ============================================================ */
    exportExcelBtn.onclick = () => {

    if (currentUser.user_type === "read") {
        statusDiv.className = "error";
        statusDiv.textContent = "Permission denied: You cannot export Excel.";
        return;
    }

    const sheetName = sheetSelect.value;
    const table = tableWrap.querySelector("table");

    if (!table) {
        statusDiv.className = "error";
        statusDiv.textContent = "Nothing to export.";
        return;
    }

    // Convert table → worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, sheetName);

    // Timestamped file name
    function getTimestamp() {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2, '0');
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const yyyy = now.getFullYear();
        const HH = String(now.getHours()).padStart(2, '0');
        const MM = String(now.getMinutes()).padStart(2, '0');
        return `${dd}${mm}${yyyy}${HH}${MM}`;
    }

    const timestamp = getTimestamp();
    const fileName = `${sheetName}_${timestamp}.xlsx`;

    // Download Excel
    XLSX.writeFile(wb, fileName);

    statusDiv.className = "success";
    statusDiv.textContent = `Excel exported successfully as: ${fileName}`;
};
document.getElementById("syncStatusBtn").addEventListener("click", async () => {

    const sheetName = sheetSelect.value;

    if (sheetName !== "FINAL_FOCUS_SELECTION") {
        statusDiv.className = "error";
        statusDiv.textContent = "Sync only works for FINAL_FOCUS_SELECTION sheet.";
        return;
    }

    statusDiv.className = "";
    statusDiv.textContent = "Syncing STATUS from Model A...";

    // 1) Load FINAL_FOCUS_SELECTION
    const finalRes = await fetch("/api/load-sheet", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            sheetId,
            sheetName: "FINAL_FOCUS_SELECTION"
        })
    });
    const finalJson = await finalRes.json();
    const finalRows = finalJson.data;

    // 2) Load LOG_FOCUS_MODEL_A
    const modelRes = await fetch("/api/load-sheet", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            sheetId,
            sheetName: "LOG_FOCUS_MODEL_A"
        })
    });
    const modelJson = await modelRes.json();
    const modelRows = modelJson.data;

    // 3) Create lookup by GameLink
    const modelMap = {};
    modelRows.forEach(r => {
        if (r.GameLink) modelMap[r.GameLink] = r.STATUS;
    });

    const changes = {};

    finalRows.forEach((row, index) => {
        const link = row.GameLink;
        if (!link) return;

        const newStatus = modelMap[link];
        if (!newStatus) return;

        if (!changes[index]) changes[index] = {};
        changes[index]["STATUS"] = newStatus;
    });

    if (Object.keys(changes).length === 0) {
        statusDiv.className = "error";
        statusDiv.textContent = "No matching GameLink values found.";
        return;
    }

    // 4) PUSH UPDATES TO GOOGLE SHEET
    const saveRes = await fetch("/api/update-cells", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            sheetId,
            sheetName: "FINAL_FOCUS_SELECTION",
            userType: "admin",
            changes
        })
    });

    const saveJson = await saveRes.json();

    if (saveJson.success) {
        statusDiv.className = "success";
        statusDiv.textContent = "STATUS synced successfully!";
    } else {
        statusDiv.className = "error";
        statusDiv.textContent = "Sync failed: " + saveJson.error;
    }
});


});


</script>

</body>
</html>
